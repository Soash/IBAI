{% extends 'base.html' %}

{% load static i18n %}

{% block title %}Lesson{% endblock %}

{% block content %}
{% include 'partials/theme-switch.html' %}

<main class="main_wrapper overflow-hidden">

    <!-- topbar__section__stert -->
    {% include 'partials/top-banner.html' %}
    <!-- topbar__section__end -->

    <!-- headar section start -->
    {% include 'partials/navbar.html' %}
    <!-- header section end -->

    <!-- Mobile Menu Start Here -->
    {% include 'partials/mobile-menu.html' %}
    <!-- Mobile Menu end Here -->

    <!-- theme fixed shadow -->
    <div>
        <div class="theme__shadow__circle"></div>
        <div class="theme__shadow__circle shadow__right"></div>
    </div>
    <!-- theme fixed shadow -->


    <!-- tution__section__start -->
    <div class="tution sp_bottom_100 sp_top_50">
        <div class="container-fluid full__width__padding">
            <div class="row">

                <!-- LEFT SIDE: LESSONS LIST -->
                <div class="col-xl-4 col-lg-12 col-md-12 col-sm-12 col-12" data-aos="fade-up">
                    <div class="accordion content__cirriculum__wrap" id="accordionExample">

                        {% for lesson in lessons %}
                        <div class="accordion-item">
                            
                            <h2 class="accordion-header" id="heading{{ lesson.id }}">
                                <button class="accordion-button" 
                                        type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#collapse{{ lesson.id }}"
                                        aria-controls="collapse{{ lesson.id }}">
                                    Lesson #{{ forloop.counter }} â€” {{ lesson.title }}
                                </button>
                            </h2>

                            <div id="collapse{{ lesson.id }}"
                                class="accordion-collapse collapse {% if lesson.slug == current_lesson_slug %}show{% endif %}"
                                aria-labelledby="heading{{ lesson.id }}"
                                data-bs-parent="#accordionExample">

                                <div class="accordion-body">
                                    {% for item in lesson.items_ordered %}
                                    <div class="scc__wrap">
                                        <div class="scc__info">
                                            {% if item.item_type == 'video' %}
                                                <i class="icofont-video-alt"></i>
                                                {% if item.id in completed_videos %}
                                                    <i class="icofont-tick-mark text-success"></i>
                                                {% endif %}
                                                <a href="{% url 'course_item' course.slug lesson.slug item.order %}">{{ item.title }}</a>
                                            {% else %}
                                                <i class="icofont-question"></i>
                                                {% if item.id in completed_exams %}
                                                    <i class="icofont-tick-mark text-success"></i>
                                                {% endif %}
                                                <a href="{% url 'course_item' course.slug lesson.slug item.order %}">{{ item.title }}</a>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        <div>
                            {% if all_completed %}
                                <div class="alert alert-success mt-3" role="alert">
                                    Congratulations! You have completed this course.
                                    {% comment %} <a href="{% url 'generate_certificate' course.slug %}" class="text-danger">Download Certificate</a> {% endcomment %}
                                    <a href="{% url 'reportlab_certificate' certificate_id %}" class="text-danger">Download Certificate</a>
                                </div>
                            {% endif %}
                        </div>

                    </div>
                </div>



                <!-- RIGHT SIDE: VIDEO PLAYER OR EXAM -->
                <div class="col-xl-8 col-lg-12 col-md-12 col-sm-12 col-12" data-aos="fade-up">
                    <div class="lesson__content__main">

                        <div class="lesson__content__wrap d-flex justify-content-between align-items-center position-relative">
                            <h3>{{ item.title }}</h3>
                            <span>
                                <a href="{% url 'course_detail' course.slug %}">Close</a>
                            </span>
                        </div>

                        {% if item.item_type == 'video' %}

                            <div class="plyr__video-embed rbtplayer" style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
                                <iframe 
                                    src="{{ item.video_url }}" 
                                    allowfullscreen 
                                    allow="autoplay"
                                    style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;">
                                </iframe>
                            </div>

                            <form method="post" class="mt-3">
                                {% csrf_token %}
                                {% if video_progress.status == False %}
                                    <button type="submit" name="mark_done" class="btn btn-success"><i class="icofont-tick-mark"></i> Mark as Complete</button>
                                {% else %}
                                    <button type="submit" name="mark_done" class="btn btn-success"><i class="icofont-tick-mark"></i> Mark as Complete</button>
                                    <div class="alert alert-info mt-3" role="alert">
                                        You have already completed this.
                                    </div>
                                {% endif %}
                            </form>

                        {% elif item.item_type == 'exam' %}

                            <form method="post" class="exam-form mt-3" data-bs-theme="auto">{% csrf_token %}
                                {% for question in item.questions.all %}
                                    <div class="card mb-3 shadow-sm border-0 bg-body-tertiary">
                                        <div class="card-header bg-body-secondary fw-semibold">
                                            <strong class="text-body">Q{{ forloop.counter }}:</strong>
                                            <span class="text-body">{{ question.text }}</span>
                                        </div>
                                        <div class="card-body bg-body">
                                            {% for option in question.options.all %}
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" 
                                                    type="radio" 
                                                    name="question_{{ question.id }}" 
                                                    value="{{ option.id }}" 
                                                    id="option_{{ option.id }}">
                                                <label class="form-check-label text-body" for="option_{{ option.id }}">
                                                    {{ option.text }}
                                                </label>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endfor %}
                                <button type="submit" name="submit_exam" class="btn btn-primary mt-2 shadow-sm">
                                    Submit Exam
                                </button>
                                {% if exam_progress.status %}
                                    <div class="alert alert-info mt-3" role="alert">
                                        You have already completed this exam.
                                    </div>
                                {% endif %}
                            </form>
                        
                            <!-- Exam History -->
                            {% if exam_attempt %}
                            <div class="mt-4">
                                <h5>Attempt History</h5>
                                <ul class="list-group">
                                    {% for attempt in exam_attempt %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>Attempt {{ forloop.counter}}</span>
                                        <span class="badge bg-primary rounded-pill">{{ attempt.score }}%</span>
                                        <span class="text-muted">{{ attempt.attempted_at|date:"M d, Y H:i T" }}</span>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                        {% endif %}
  
                    </div>
                </div>


            </div>
        </div>
    </div>
    <!-- tution__section__end -->

    {% include 'partials/footer.html' %}
</main>

{% endblock %}


{% block extra_javascript %}

{% endblock extra_javascript %}
    